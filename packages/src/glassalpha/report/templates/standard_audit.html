<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{ report_title | default("ML Model Audit Report") }}</title>

    <style>
      /* Professional styling for regulatory audit reports */

      /* Root variables for consistent theming */
      :root {
        --primary-color: #2e3440;
        --secondary-color: #5e81ac;
        --accent-color: #88c0d0;
        --success-color: #a3be8c;
        --warning-color: #ebcb8b;
        --error-color: #bf616a;
        --neutral-color: #d8dee9;
        --background-color: #eceff4;
        --text-color: #2e3440;
        --light-gray: #f5f6f8;
        --border-color: #e1e3e6;
      }

      /* Base styles */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", -apple-system, BlinkMacSystemFont, "Roboto",
          "Helvetica Neue", Arial, sans-serif;
        line-height: 1.6;
        color: var(--text-color);
        background-color: white;
        font-size: 11pt;
      }

      /* Print-specific styles */
      @media print {
        body {
          font-size: 10pt;
          line-height: 1.4;
        }

        .page-break {
          page-break-before: always;
        }

        .no-print {
          display: none !important;
        }

        .section {
          break-inside: avoid;
        }

        h1,
        h2,
        h3 {
          break-after: avoid;
        }

        table {
          break-inside: avoid;
        }
      }

      /* Layout containers */
      .container {
        max-width: 8.5in;
        margin: 0 auto;
        padding: 0.5in;
        background: white;
      }

      .header {
        text-align: center;
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 3px solid var(--primary-color);
      }

      .footer {
        text-align: center;
        margin-top: 2rem;
        padding-top: 1rem;
        border-top: 1px solid var(--border-color);
        font-size: 9pt;
        color: #666;
      }

      /* Typography */
      h1 {
        font-size: 24pt;
        font-weight: 700;
        color: var(--primary-color);
        margin-bottom: 0.5rem;
      }

      h2 {
        font-size: 16pt;
        font-weight: 600;
        color: var(--primary-color);
        margin-top: 1.5rem;
        margin-bottom: 1rem;
        padding-bottom: 0.25rem;
        border-bottom: 2px solid var(--secondary-color);
      }

      h3 {
        font-size: 13pt;
        font-weight: 600;
        color: var(--text-color);
        margin-top: 1rem;
        margin-bottom: 0.5rem;
      }

      h4 {
        font-size: 11pt;
        font-weight: 600;
        color: var(--text-color);
        margin-top: 0.75rem;
        margin-bottom: 0.25rem;
      }

      /* Sections and content */
      .section {
        margin-bottom: 2rem;
        padding: 1rem;
        border-radius: 8px;
        background-color: var(--light-gray);
        border: 1px solid var(--border-color);
      }

      .executive-summary {
        background-color: #f8f9ff;
        border-left: 4px solid var(--secondary-color);
      }

      .warning-section {
        background-color: #fff8e6;
        border-left: 4px solid var(--warning-color);
      }

      .error-section {
        background-color: #ffebee;
        border-left: 4px solid var(--error-color);
      }

      /* Tables */
      .table-container {
        margin: 1rem 0;
        overflow-x: auto;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin: 0.5rem 0;
        background: white;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }

      th,
      td {
        padding: 0.5rem;
        text-align: left;
        border-bottom: 1px solid var(--border-color);
      }

      th {
        background-color: var(--primary-color);
        color: white;
        font-weight: 600;
        font-size: 10pt;
      }

      td {
        font-size: 10pt;
      }

      tr:nth-child(even) {
        background-color: #f9f9f9;
      }

      tr:hover {
        background-color: #f0f8ff;
      }

      /* Metric values styling */
      .metric-value {
        font-weight: 600;
        font-size: 11pt;
      }

      .metric-good {
        color: var(--success-color);
      }

      .metric-warning {
        color: var(--warning-color);
      }

      .metric-poor {
        color: var(--error-color);
      }

      /* Status indicators */
      .status-indicator {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 9pt;
        font-weight: 600;
        text-transform: uppercase;
      }

      .status-pass {
        background-color: var(--success-color);
        color: white;
      }

      .status-fail {
        background-color: var(--error-color);
        color: white;
      }

      .status-warning {
        background-color: var(--warning-color);
        color: var(--text-color);
      }

      /* Plot containers */
      .plot-container {
        margin: 1rem 0;
        text-align: center;
        page-break-inside: avoid;
      }

      .plot-container img {
        max-width: 100%;
        height: auto;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .plot-caption {
        font-size: 9pt;
        color: #666;
        margin-top: 0.5rem;
        font-style: italic;
      }

      /* Key-value pairs */
      .info-grid {
        display: grid;
        grid-template-columns: auto 1fr;
        gap: 0.5rem;
        margin: 1rem 0;
      }

      .info-label {
        font-weight: 600;
        color: var(--text-color);
      }

      .info-value {
        color: var(--text-color);
      }

      /* Lists */
      ul,
      ol {
        margin: 0.5rem 0;
        padding-left: 1.5rem;
      }

      li {
        margin-bottom: 0.25rem;
      }

      /* Code and monospace */
      code,
      .monospace {
        font-family: "Monaco", "Menlo", "Ubuntu Mono", monospace;
        font-size: 9pt;
        background-color: #f5f5f5;
        padding: 0.125rem 0.25rem;
        border-radius: 3px;
        border: 1px solid #ddd;
      }

      pre {
        background-color: #f8f8f8;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 1rem;
        overflow-x: auto;
        font-size: 9pt;
        line-height: 1.4;
      }

      /* Callout boxes */
      .callout {
        padding: 1rem;
        margin: 1rem 0;
        border-radius: 6px;
        border: 1px solid var(--border-color);
      }

      .callout-info {
        background-color: #e3f2fd;
        border-left: 4px solid #2196f3;
      }

      .callout-success {
        background-color: #e8f5e8;
        border-left: 4px solid var(--success-color);
      }

      .callout-warning {
        background-color: #fff3cd;
        border-left: 4px solid var(--warning-color);
      }

      .callout-danger {
        background-color: #f8d7da;
        border-left: 4px solid var(--error-color);
      }

      .callout-error {
        background-color: #ffebee;
        border-left: 4px solid var(--error-color);
      }

      /* Component card */
      .component-card {
        background-color: var(--light-gray);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        padding: 1rem;
        margin: 1rem 0;
      }

      .component-card h4 {
        margin-top: 0;
        color: var(--secondary-color);
        font-size: 12pt;
      }

      .info-section {
        margin-top: 0.75rem;
        padding-top: 0.75rem;
        border-top: 1px solid var(--border-color);
      }

      .compact-table {
        font-size: 9pt;
      }

      .compact-table th,
      .compact-table td {
        padding: 0.4rem;
      }

      /* Two-column layout */
      .two-column {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin: 1rem 0;
      }

      @media print {
        .two-column {
          grid-template-columns: 1fr;
        }
      }

      /* Badges and tags */
      .badge {
        display: inline-block;
        padding: 0.125rem 0.375rem;
        font-size: 8pt;
        font-weight: 600;
        border-radius: 3px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .badge-primary {
        background-color: var(--primary-color);
        color: white;
      }

      .badge-success {
        background-color: var(--success-color);
        color: white;
      }

      .badge-warning {
        background-color: var(--warning-color);
        color: var(--text-color);
      }

      .badge-danger {
        background-color: var(--error-color);
        color: white;
      }

      /* Utility classes */
      .text-center {
        text-align: center;
      }
      .text-right {
        text-align: right;
      }
      .text-muted {
        color: #666;
      }
      .text-small {
        font-size: 9pt;
      }
      .font-bold {
        font-weight: 600;
      }
      .mb-1 {
        margin-bottom: 0.5rem;
      }
      .mb-2 {
        margin-bottom: 1rem;
      }
      .mt-1 {
        margin-top: 0.5rem;
      }
      .mt-2 {
        margin-top: 1rem;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Header Section -->
      <header class="header">
        <h1>{{ report_title | default("ML Model Audit Report") }}</h1>
        <div class="text-muted">
          <strong>Generated:</strong> {{ generation_date }}<br />
          <strong>Audit ID:</strong> <code>{{ audit_id | default("N/A") }}</code
          ><br />
          {% if audit_profile %}
          <strong>Profile:</strong>
          <span class="badge badge-primary">{{ audit_profile }}</span>
          {% endif %} {% if strict_mode %}
          <span class="badge badge-warning">Strict Mode</span>
          {% endif %}
        </div>
      </header>

      <!-- Executive Summary -->
      <section class="section executive-summary">
        <h2>Executive Summary</h2>

        <div class="two-column">
          <div>
            <h4>Model Overview</h4>
            <div class="info-grid">
              <span class="info-label">Model Type:</span>
              <span class="info-value"
                >{{ model_info.type | default("N/A") | title }}</span
              >

              <span class="info-label">Dataset:</span>
              <span class="info-value">
                {{ data_summary.shape[0] if data_summary.shape else "N/A" }}
                samples, {{ data_summary.shape[1] if data_summary.shape else
                "N/A" }} features
              </span>

              <span class="info-label">Target:</span>
              <span class="info-value"
                >{{ schema_info.target | default("N/A") }}</span
              >

              <span class="info-label">Protected Attributes:</span>
              <span class="info-value">
                {% if schema_info.sensitive_features %} {{
                schema_info.sensitive_features | join(", ") }} {% else %} None
                specified {% endif %}
              </span>
            </div>
          </div>

          <div>
            <h4>Key Findings</h4>
            <ul>
              {% if model_performance.accuracy %}
              <li>
                <strong>Overall Accuracy:</strong>
                {% set acc = model_performance.accuracy.value if
                model_performance.accuracy is mapping and
                model_performance.accuracy.value is defined else
                model_performance.accuracy %}
                <span
                  class="metric-value metric-{{ 'good' if acc > 0.8 else ('warning' if acc > 0.6 else 'poor') }}"
                >
                  {{ "%.1f%%" | format(acc * 100) }}
                </span>
              </li>
              {% endif %} {% set bias_detected = [] %} {% for attr, metrics in
              fairness_analysis.items() %} {% for metric, result in
              metrics.items() %} {% if result.is_fair is defined and not
              result.is_fair %} {% set _ = bias_detected.append(attr) %} {%
              endif %} {% endfor %} {% endfor %}

              <li>
                <strong>Bias Detection:</strong>
                {% if bias_detected %}
                <span class="status-indicator status-warning"
                  >{{ bias_detected | length }} Issue(s) Found</span
                >
                <br /><small class="text-muted"
                  >Bias detected in: {{ bias_detected | unique | join(", ")
                  }}</small
                >
                {% else %}
                <span class="status-indicator status-pass"
                  >No Issues Detected</span
                >
                {% endif %}
              </li>

              <li>
                <strong>Explainability:</strong>
                {% if explanations and explanations.global_importance %}
                <span class="status-indicator status-pass">Available</span>
                {% else %}
                <span class="status-indicator status-fail">Not Available</span>
                {% endif %}
              </li>

              <li>
                <strong>Reproducibility:</strong>
                {% if manifest.seeds %}
                <span class="status-indicator status-pass"
                  >Fully Reproducible</span
                >
                {% else %}
                <span class="status-indicator status-warning">Limited</span>
                {% endif %}
              </li>
            </ul>
          </div>
        </div>

        {% set acc_val = model_performance.accuracy.value if
        model_performance.accuracy is mapping and
        model_performance.accuracy.value is defined else
        model_performance.accuracy if model_performance.accuracy else 0 %} {% if
        bias_detected or (model_performance.accuracy and acc_val < 0.7) %}
        <div class="callout callout-warning">
          <h4>WARNING: Regulatory Attention Required</h4>
          <p>
            This model shows potential issues that may require regulatory review
            before deployment:
          </p>
          <ul>
            {% if bias_detected %}
            <li>
              Potential bias detected in protected attributes: {{ bias_detected
              | unique | join(", ") }}
            </li>
            {% endif %} {% if model_performance.accuracy and acc_val < 0.7 %}
            <li>
              Model accuracy below recommended threshold ({{ "%.1f%%" |
              format(acc_val * 100) }} &lt; 70%)
            </li>
            {% endif %}
          </ul>
        </div>
        {% endif %}
      </section>

      <div class="page-break"></div>

      <!-- Data Overview -->
      <section class="section">
        <h2>Data Overview</h2>

        <h3>Dataset Statistics</h3>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Metric</th>
                <th>Value</th>
                <th>Description</th>
              </tr>
            </thead>
            <tbody>
              {% if data_summary %}
              <tr>
                <td><strong>Total Samples</strong></td>
                <td class="metric-value">
                  {{ "{:,}".format(data_summary.shape[0]) if data_summary.shape
                  else "N/A" }}
                </td>
                <td>Number of observations in the dataset</td>
              </tr>
              <tr>
                <td><strong>Total Features</strong></td>
                <td class="metric-value">
                  {{ data_summary.shape[1] if data_summary.shape else "N/A" }}
                </td>
                <td>Number of input variables</td>
              </tr>
              <tr>
                <td><strong>Missing Values</strong></td>
                <td class="metric-value">
                  {{ data_summary.missing_count | default(0) }}
                </td>
                <td>Count of missing data points</td>
              </tr>
              <tr>
                <td><strong>Data Quality Score</strong></td>
                <td
                  class="metric-value metric-{{ 'good' if (data_summary.missing_count | default(0)) < 50 else 'warning' }}"
                >
                  {{ "%.1f%%" | format(((data_summary.shape[0] *
                  data_summary.shape[1] - (data_summary.missing_count |
                  default(0))) / (data_summary.shape[0] * data_summary.shape[1])
                  * 100) if data_summary.shape else 0) }}
                </td>
                <td>Percentage of complete data points</td>
              </tr>
              {% endif %}
            </tbody>
          </table>
        </div>

        {% if schema_info %}
        <h3>Feature Schema</h3>
        <div class="two-column">
          <div>
            <h4>Categorical Features</h4>
            <ul class="text-small">
              {% if schema_info and schema_info.categorical_features %} {% for
              feature in schema_info.categorical_features %}
              <li>{{ feature | replace("_", " ") | title }}</li>
              {% endfor %} {% else %}
              <li class="text-muted">None specified</li>
              {% endif %}
            </ul>
          </div>
          <div>
            <h4>Numerical Features</h4>
            <ul class="text-small">
              {% if schema_info and schema_info.numeric_features %} {% for
              feature in schema_info.numeric_features %}
              <li>{{ feature | replace("_", " ") | title }}</li>
              {% endfor %} {% else %}
              <li class="text-muted">None specified</li>
              {% endif %}
            </ul>
          </div>
        </div>
        {% endif %}
      </section>

      <!-- Preprocessing -->
      {% if preprocessing_info %}
      <div class="page-break"></div>
      <section class="section">
        <h2>Preprocessing Verification</h2>

        {% if preprocessing_info.mode == 'auto' %}
        <div class="callout callout-error">
          <h4>⚠️ WARNING: Non-Compliant Preprocessing Mode</h4>
          <p>
            This audit used <strong>AUTO preprocessing mode</strong>, which is
            <strong>NOT suitable for regulatory compliance</strong>. Auto mode
            dynamically fits preprocessing transformers to the audit data,
            creating a different preprocessing pipeline than production.
          </p>
          <p><strong>For compliance-grade audits:</strong></p>
          <ul>
            <li>Use <code>mode: artifact</code> in preprocessing config</li>
            <li>Provide the exact preprocessing artifact used in production</li>
            <li>
              Include both <code>expected_file_hash</code> and
              <code>expected_params_hash</code>
            </li>
          </ul>
          <p class="text-muted">
            <small>
              See documentation: <code>docs/preprocessing.md</code>
            </small>
          </p>
        </div>
        {% elif preprocessing_info.mode == 'artifact' %}
        <div class="callout callout-success">
          <h4>✓ Production Artifact Verified</h4>
          <p>
            This audit used a
            <strong>verified preprocessing artifact</strong> from production,
            ensuring the model was evaluated with the exact same transformations
            used in deployment.
          </p>
        </div>
        {% endif %}

        <h3>Preprocessing Summary</h3>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Property</th>
                <th>Value</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><strong>Mode</strong></td>
                <td>
                  <code>{{ preprocessing_info.mode }}</code>
                </td>
                <td>
                  {% if preprocessing_info.mode == 'artifact' %}
                  <span class="status-indicator status-pass">Compliant</span>
                  {% else %}
                  <span class="status-indicator status-fail"
                    >Non-Compliant</span
                  >
                  {% endif %}
                </td>
              </tr>
              {% if preprocessing_info.artifact_path %}
              <tr>
                <td><strong>Artifact Path</strong></td>
                <td>
                  <code class="text-small"
                    >{{ preprocessing_info.artifact_path }}</code
                  >
                </td>
                <td>—</td>
              </tr>
              {% endif %} {% if preprocessing_info.file_hash %}
              <tr>
                <td><strong>File Hash (SHA256)</strong></td>
                <td>
                  <code class="text-small"
                    >{{ preprocessing_info.file_hash | replace('sha256:', '')
                    }}</code
                  >
                </td>
                <td>
                  <span class="status-indicator status-pass">Verified</span>
                </td>
              </tr>
              {% endif %} {% if preprocessing_info.params_hash %}
              <tr>
                <td><strong>Params Hash (SHA256)</strong></td>
                <td>
                  <code class="text-small"
                    >{{ preprocessing_info.params_hash | replace('sha256:', '')
                    }}</code
                  >
                </td>
                <td>
                  <span class="status-indicator status-pass">Verified</span>
                </td>
              </tr>
              {% endif %}
            </tbody>
          </table>
        </div>

        {% if preprocessing_info.manifest and
        preprocessing_info.manifest.components %}
        <h3>Preprocessing Components</h3>
        <p class="text-muted">
          Learned parameters extracted from the preprocessing artifact. These
          values were fitted on production training data and applied to audit
          data.
        </p>

        {% for component in preprocessing_info.manifest.components %}
        <div class="component-card">
          <h4>{{ component.name }}</h4>
          <div class="info-grid">
            <span class="info-label">Class:</span>
            <span class="info-value">
              <code class="text-small">{{ component.class }}</code>
            </span>

            {% if component.strategy %}
            <span class="info-label">Strategy:</span>
            <span class="info-value">{{ component.strategy }}</span>
            {% endif %} {% if component.handle_unknown %}
            <span class="info-label">Handle Unknown:</span>
            <span class="info-value">{{ component.handle_unknown }}</span>
            {% endif %} {% if component.drop %}
            <span class="info-label">Drop:</span>
            <span class="info-value">{{ component.drop }}</span>
            {% endif %} {% if component.sparse_output is not none %}
            <span class="info-label">Sparse Output:</span>
            <span class="info-value">{{ component.sparse_output }}</span>
            {% endif %}
          </div>

          {% if component.columns %}
          <div class="info-section">
            <strong
              >Applied to columns ({{ component.columns | length }}):</strong
            >
            <div class="text-small text-muted">
              {{ component.columns | join(", ") }}
            </div>
          </div>
          {% endif %} {% if component.learned_stats %}
          <div class="info-section">
            <strong>Learned Statistics:</strong>
            <div class="table-container">
              <table class="compact-table">
                <thead>
                  <tr>
                    <th>Column</th>
                    <th>Value</th>
                  </tr>
                </thead>
                <tbody>
                  {% for i in range(component.learned_stats | length) %}
                  <tr>
                    <td class="text-small">
                      {{ component.columns[i] if component.columns and i <
                      (component.columns | length) else ("Column " + (i |
                      string)) }}
                    </td>
                    <td class="text-small">
                      {% set val = component.learned_stats[i] %} {% if val is
                      number %} {{ "%.4f" | format(val) }} {% else %} {{ val }}
                      {% endif %}
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
          {% endif %} {% if component.mean or component.scale %}
          <div class="info-section">
            <strong>Scaling Parameters:</strong>
            <div class="table-container">
              <table class="compact-table">
                <thead>
                  <tr>
                    <th>Column</th>
                    {% if component.mean %}
                    <th>Mean</th>
                    {% endif %} {% if component.scale %}
                    <th>Scale</th>
                    {% endif %}
                  </tr>
                </thead>
                <tbody>
                  {% for i in range((component.mean | length) if component.mean
                  else (component.scale | length)) %}
                  <tr>
                    <td class="text-small">
                      {{ component.columns[i] if component.columns and i <
                      (component.columns | length) else ("Column " + (i |
                      string)) }}
                    </td>
                    {% if component.mean %}
                    <td class="text-small">
                      {{ "%.4f" | format(component.mean[i]) }}
                    </td>
                    {% endif %} {% if component.scale %}
                    <td class="text-small">
                      {{ "%.4f" | format(component.scale[i]) }}
                    </td>
                    {% endif %}
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
          {% endif %} {% if component.categories %}
          <div class="info-section">
            <strong>Encoder Categories (showing up to 10 per column):</strong>
            <div class="table-container">
              <table class="compact-table">
                <thead>
                  <tr>
                    <th>Column</th>
                    <th>Categories</th>
                    <th>Count</th>
                  </tr>
                </thead>
                <tbody>
                  {% for i in range(component.categories | length) %}
                  <tr>
                    <td class="text-small">
                      {{ component.columns[i] if component.columns and i <
                      (component.columns | length) else ("Column " + (i |
                      string)) }}
                    </td>
                    <td class="text-small">
                      {% set cats = component.categories[i] %} {% if cats |
                      length > 10 %} {{ cats[:10] | join(", ") }}, ... ({{ cats
                      | length - 10 }} more) {% else %} {{ cats | join(", ") }}
                      {% endif %}
                    </td>
                    <td class="text-small">
                      {{ component.categories[i] | length }}
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
          {% endif %}
        </div>
        {% endfor %} {% endif %} {% if preprocessing_info.manifest and
        preprocessing_info.manifest.artifact_runtime_versions %}
        <h3>Runtime Version Information</h3>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Library</th>
                <th>Artifact Version</th>
                <th>Audit Version</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              {% for lib, artifact_ver in
              preprocessing_info.manifest.artifact_runtime_versions.items() %}
              {% set audit_ver =
              preprocessing_info.manifest.audit_runtime_versions[lib] if
              preprocessing_info.manifest.audit_runtime_versions else "N/A" %}
              <tr>
                <td><strong>{{ lib }}</strong></td>
                <td><code>{{ artifact_ver }}</code></td>
                <td><code>{{ audit_ver }}</code></td>
                <td>
                  {% if artifact_ver == audit_ver %}
                  <span class="status-indicator status-pass">Match</span>
                  {% else %}
                  <span class="status-indicator status-warning">Mismatch</span>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% endif %} {% if preprocessing_unknown_rates %}
        <h3>Unknown Category Detection</h3>
        <p class="text-muted">
          Unknown categories are values in the audit data that were not seen
          during the training of the preprocessing artifact. High unknown rates
          may indicate distribution shift or data quality issues.
        </p>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Column</th>
                <th>Unknown Rate</th>
                <th>Assessment</th>
              </tr>
            </thead>
            <tbody>
              {% for col, rate in preprocessing_unknown_rates.items() %}
              <tr>
                <td><strong>{{ col }}</strong></td>
                <td class="metric-value">
                  {{ "%.2f%%" | format(rate * 100) }}
                </td>
                <td>
                  {% if rate > 0.10 %}
                  <span class="status-indicator status-fail">High</span>
                  {% elif rate > 0.01 %}
                  <span class="status-indicator status-warning">Moderate</span>
                  {% else %}
                  <span class="status-indicator status-pass">Low</span>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% endif %}
      </section>
      {% endif %}

      <!-- Model Performance -->
      <section class="section">
        <h2>Model Performance Analysis</h2>

        {% if model_performance %}
        <h3>Performance Metrics</h3>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Metric</th>
                <th>Value</th>
                <th>Assessment</th>
                <th>Description</th>
              </tr>
            </thead>
            <tbody>
              {% for metric_name, metric_data in model_performance.items() %} {%
              if metric_data is mapping %} {% if metric_name ==
              "classification_report" %}
              <tr>
                <td><strong>Overall Accuracy</strong></td>
                <td class="metric-value">
                  {{ "%.3f" | format(metric_data.accuracy) }}
                </td>
                <td>
                  <span
                    class="status-indicator status-{{ 'pass' if metric_data.accuracy > 0.8 else ('warning' if metric_data.accuracy > 0.6 else 'fail') }}"
                  >
                    {{ 'Excellent' if metric_data.accuracy > 0.9 else ('Good' if
                    metric_data.accuracy > 0.8 else ('Fair' if
                    metric_data.accuracy > 0.6 else 'Poor')) }}
                  </span>
                </td>
                <td>Overall classification accuracy</td>
              </tr>
              {% if metric_data.macro_precision is defined %}
              <tr>
                <td><strong>Macro Precision</strong></td>
                <td class="metric-value">
                  {{ "%.3f" | format(metric_data.macro_precision) }}
                </td>
                <td>
                  <span
                    class="status-indicator status-{{ 'pass' if metric_data.macro_precision > 0.8 else ('warning' if metric_data.macro_precision > 0.6 else 'fail') }}"
                  >
                    {{ 'Good' if metric_data.macro_precision > 0.8 else ('Fair'
                    if metric_data.macro_precision > 0.6 else 'Poor') }}
                  </span>
                </td>
                <td>Average precision across all classes</td>
              </tr>
              {% endif %} {% else %} {% set value = metric_data.value if
              metric_data.value is defined else metric_data.accuracy if
              metric_data.accuracy is defined else metric_data %} {% if value is
              number %}
              <tr>
                <td>
                  <strong>{{ metric_name | replace("_", " ") | title }}</strong>
                </td>
                <td class="metric-value">{{ "%.3f" | format(value) }}</td>
                <td>
                  <span
                    class="status-indicator status-{{ 'pass' if value > 0.8 else ('warning' if value > 0.6 else 'fail') }}"
                  >
                    {{ 'Good' if value > 0.8 else ('Fair' if value > 0.6 else
                    'Poor') }}
                  </span>
                </td>
                <td>
                  {{ metric_descriptions.get(metric_name, "Performance metric")
                  }}
                </td>
              </tr>
              {% endif %} {% endif %} {% elif metric_data is number %}
              <tr>
                <td>
                  <strong>{{ metric_name | replace("_", " ") | title }}</strong>
                </td>
                <td class="metric-value">{{ "%.3f" | format(metric_data) }}</td>
                <td>
                  <span
                    class="status-indicator status-{{ 'pass' if metric_data > 0.8 else ('warning' if metric_data > 0.6 else 'fail') }}"
                  >
                    {{ 'Good' if metric_data > 0.8 else ('Fair' if metric_data >
                    0.6 else 'Poor') }}
                  </span>
                </td>
                <td>
                  {{ metric_descriptions.get(metric_name, "Performance metric")
                  }}
                </td>
              </tr>
              {% endif %} {% endfor %}
            </tbody>
          </table>
        </div>
        {% endif %}

        <!-- Performance Plots -->
        {% if performance_plots %}
        <h3>Performance Visualizations</h3>
        {% for plot_name, plot_path in performance_plots.items() %}
        <div class="plot-container">
          <img
            src="{{ plot_path }}"
            alt="{{ plot_name | replace('_', ' ') | title }} Plot"
          />
          <div class="plot-caption">
            {{ plot_name | replace('_', ' ') | title }} - {{
            plot_descriptions.get(plot_name, "Model performance visualization")
            }}
          </div>
        </div>
        {% endfor %} {% endif %}
      </section>

      <div class="page-break"></div>

      <!-- SHAP Explanations -->
      {% if explanations %}
      <section class="section">
        <h2>Model Explainability (SHAP Analysis)</h2>

        {% if explanations.global_importance %}
        <h3>Feature Importance</h3>
        <p>
          The following features have the greatest impact on model predictions:
        </p>

        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Feature</th>
                <th>SHAP Value</th>
                <th>Impact</th>
                <th>Interpretation</th>
              </tr>
            </thead>
            <tbody>
              {% if explanations and explanations.global_importance %} {% for
              feature, importance in (explanations.global_importance.items() |
              list)[:10] %}
              <tr>
                <td>
                  <strong>{{ feature | replace("_", " ") | title }}</strong>
                </td>
                <td class="metric-value">{{ "%.3f" | format(importance) }}</td>
                <td>
                  <span
                    class="badge badge-{{ 'success' if importance > 0 else 'danger' }}"
                  >
                    {{ 'Positive' if importance > 0 else 'Negative' }}
                  </span>
                </td>
                <td class="text-small">
                  {{ 'Increases' if importance > 0 else 'Decreases' }}
                  prediction probability (magnitude: {{ 'High' if
                  (importance|abs) > 0.1 else ('Medium' if (importance|abs) >
                  0.05 else 'Low') }})
                </td>
              </tr>
              {% endfor %} {% endif %}
            </tbody>
          </table>
        </div>
        {% endif %}

        <!-- SHAP Plots -->
        {% if shap_plots %}
        <h3>SHAP Visualizations</h3>
        {% for plot_name, plot_path in shap_plots.items() %}
        <div class="plot-container">
          <img
            src="{{ plot_path }}"
            alt="{{ plot_name | replace('_', ' ') | title }} Plot"
          />
          <div class="plot-caption">
            {{ plot_name | replace('_', ' ') | title }} - {{
            shap_descriptions.get(plot_name, "SHAP explanation visualization")
            }}
          </div>
        </div>
        {% endfor %} {% endif %}

        <div class="callout callout-info">
          <h4>Understanding SHAP Values</h4>
          <p>
            SHAP (SHapley Additive exPlanations) values explain individual
            predictions by quantifying the contribution of each feature:
          </p>
          <ul>
            <li>
              <strong>Positive values</strong> push the prediction toward the
              positive class
            </li>
            <li>
              <strong>Negative values</strong> push the prediction toward the
              negative class
            </li>
            <li>
              <strong>Magnitude</strong> indicates the strength of the feature's
              influence
            </li>
            <li>
              <strong>Sum of all SHAP values</strong> equals the difference from
              the baseline prediction
            </li>
          </ul>
        </div>
      </section>
      {% endif %}

      <div class="page-break"></div>

      <!-- Fairness Analysis -->
      {% if fairness_analysis %}
      <section class="section">
        <h2>Fairness & Bias Analysis</h2>

        <p>Analysis of potential bias across protected demographic groups:</p>

        {% for attr_name, attr_metrics in fairness_analysis.items() %}
        <h3>{{ attr_name | replace("_", " ") | title }} Analysis</h3>

        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Fairness Metric</th>
                <th>Result</th>
                <th>Status</th>
                <th>Interpretation</th>
              </tr>
            </thead>
            <tbody>
              {% for metric_name, metric_result in attr_metrics.items() %}
              <tr>
                <td>
                  <strong>{{ metric_name | replace("_", " ") | title }}</strong>
                </td>
                <td class="metric-value">
                  {% if metric_result is mapping %} {% if metric_result.error is
                  defined %}
                  <span class="text-muted"
                    >Error: {{ metric_result.error[:50] }}...</span
                  >
                  {% elif metric_result.ratio is defined %} {{ "%.3f" |
                  format(metric_result.ratio) }} {% elif
                  metric_result.difference is defined %} {{ "%.3f" |
                  format(metric_result.difference) }} {% else %} {{
                  metric_result }} {% endif %} {% else %} {{ metric_result }} {%
                  endif %}
                </td>
                <td>
                  {% if metric_result is mapping and metric_result.error is
                  defined %}
                  <span class="status-indicator status-warning">Error</span>
                  {% elif metric_result is mapping and metric_result.is_fair is
                  defined %}
                  <span
                    class="status-indicator status-{{ 'pass' if metric_result.is_fair else 'fail' }}"
                  >
                    {{ 'Fair' if metric_result.is_fair else 'Biased' }}
                  </span>
                  {% else %}
                  <span class="status-indicator status-warning">Unknown</span>
                  {% endif %}
                </td>
                <td class="text-small">
                  {% if metric_result is mapping and metric_result.error is
                  defined %} Metric computation failed {% elif metric_result is
                  mapping and metric_result.is_fair is defined %} {% if
                  metric_result.is_fair %} No significant bias detected {% else
                  %} Potential bias detected - requires review {% endif %} {%
                  else %} Unable to assess fairness {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% endfor %}

        <!-- Fairness Plots -->
        {% if fairness_plots %}
        <h3>Fairness Visualizations</h3>
        {% for plot_name, plot_path in fairness_plots.items() %}
        <div class="plot-container">
          <img
            src="{{ plot_path }}"
            alt="{{ plot_name | replace('_', ' ') | title }} Plot"
          />
          <div class="plot-caption">
            {{ plot_name | replace('_', ' ') | title }} - Bias detection across
            demographic groups
          </div>
        </div>
        {% endfor %} {% endif %}

        <div class="callout callout-warning">
          <h4>Regulatory Considerations</h4>
          <p>Key points for regulatory compliance:</p>
          <ul>
            <li>
              <strong>Demographic Parity:</strong> Equal positive prediction
              rates across groups
            </li>
            <li>
              <strong>Equal Opportunity:</strong> Equal true positive rates for
              qualified individuals
            </li>
            <li>
              <strong>Equalized Odds:</strong> Equal true positive and false
              positive rates
            </li>
            <li>
              <strong>Predictive Parity:</strong> Equal precision across
              demographic groups
            </li>
          </ul>
          <p>
            Any "Biased" status may require model adjustment or additional
            oversight before deployment.
          </p>
        </div>
      </section>
      {% endif %}

      <div class="page-break"></div>

      <!-- Audit Trail & Reproducibility -->
      <section class="section">
        <h2>Audit Trail & Reproducibility</h2>

        <h3>Execution Information</h3>
        <div class="info-grid">
          {% if manifest %}
          <span class="info-label">Audit ID:</span>
          <span class="info-value"
            ><code>{{ manifest.audit_id | default("N/A") }}</code></span
          >

          <span class="info-label">Creation Time:</span>
          <span class="info-value"
            >{{ manifest.creation_time | default("N/A") }}</span
          >

          <span class="info-label">Duration:</span>
          <span class="info-value">
            {{ "%.2f seconds" | format(manifest.execution.duration_seconds) if
            manifest.execution and manifest.execution.duration_seconds else
            "N/A" }}
          </span>

          <span class="info-label">Status:</span>
          <span class="info-value">
            <span
              class="status-indicator status-{{ 'pass' if manifest.execution.status == 'completed' else 'fail' }}"
            >
              {{ manifest.execution.status | default("Unknown") | title }}
            </span>
          </span>
          {% endif %}
        </div>

        <h3>Reproducibility Information</h3>
        {% if manifest and manifest.seeds %}
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Component</th>
                <th>Seed Value</th>
                <th>Purpose</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><strong>Master Seed</strong></td>
                <td><code>{{ manifest.seeds.master_seed }}</code></td>
                <td>Global randomness control</td>
              </tr>
              {% if manifest and manifest.seeds and
              manifest.seeds.component_seeds %} {% for component, seed in
              manifest.seeds.component_seeds.items() %}
              <tr>
                <td>{{ component | replace("_", " ") | title }}</td>
                <td><code>{{ seed }}</code></td>
                <td>Component-specific randomness</td>
              </tr>
              {% endfor %} {% endif %}
            </tbody>
          </table>
        </div>
        {% endif %}

        <h3>Selected Components</h3>
        {% if manifest and manifest.selected_components %}
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Component Type</th>
                <th>Selected Implementation</th>
                <th>Version</th>
              </tr>
            </thead>
            <tbody>
              {% if manifest and manifest.selected_components %} {% for
              component_key, component_info in
              manifest.selected_components.items() %}
              <tr>
                <td><strong>{{ component_info.type | title }}</strong></td>
                <td>{{ component_info.name | title }}</td>
                <td>
                  <code>{{ component_info.version | default("N/A") }}</code>
                </td>
              </tr>
              {% endfor %} {% endif %}
            </tbody>
          </table>
        </div>
        {% endif %}

        <h3>Environment Information</h3>
        {% if manifest and manifest.environment %}
        <div class="info-grid">
          <span class="info-label">Python Version:</span>
          <span class="info-value"
            ><code
              >{{ manifest.environment.python_version.split()[0] if
              manifest.environment.python_version else "N/A" }}</code
            ></span
          >

          <span class="info-label">Platform:</span>
          <span class="info-value"
            >{{ manifest.environment.platform | default("N/A") }}</span
          >

          <span class="info-label">Hostname:</span>
          <span class="info-value"
            >{{ manifest.environment.hostname | default("N/A") }}</span
          >

          <span class="info-label">Working Directory:</span>
          <span class="info-value"
            ><code
              >{{ manifest.environment.working_directory | default("N/A")
              }}</code
            ></span
          >
        </div>
        {% endif %} {% if manifest and manifest.git %}
        <h3>Version Control</h3>
        <div class="info-grid">
          <span class="info-label">Git Commit:</span>
          <span class="info-value"
            ><code
              >{{ manifest.git.commit_hash[:12] if manifest.git.commit_hash else
              "N/A" }}</code
            ></span
          >

          <span class="info-label">Branch:</span>
          <span class="info-value"
            >{{ manifest.git.branch | default("N/A") }}</span
          >

          <span class="info-label">Working Directory Status:</span>
          <span class="info-value">
            <span
              class="status-indicator status-{{ 'pass' if not manifest.git.is_dirty else 'warning' }}"
            >
              {{ 'Clean' if not manifest.git.is_dirty else 'Modified' }}
            </span>
          </span>
        </div>
        {% endif %}

        <div class="callout callout-success">
          <h4>Reproducibility Guarantee</h4>
          <p>
            This audit is fully reproducible. Running the same configuration
            with identical data and environment will produce byte-identical
            results.
          </p>
          {% if manifest and manifest.config_hash %}
          <p>
            <strong>Configuration Hash:</strong>
            <code>{{ manifest.config_hash[:16] }}...</code>
          </p>
          {% endif %}
        </div>
      </section>

      <div class="page-break"></div>

      <!-- Regulatory Compliance -->
      <section class="section">
        <h2>Regulatory Compliance Assessment</h2>

        <h3>Compliance Checklist</h3>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Requirement</th>
                <th>Status</th>
                <th>Evidence</th>
                <th>Notes</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><strong>Model Documentation</strong></td>
                <td>
                  <span class="status-indicator status-pass">Complete</span>
                </td>
                <td>Full audit report generated</td>
                <td>Comprehensive model documentation provided</td>
              </tr>
              <tr>
                <td><strong>Performance Validation</strong></td>
                <td>
                  <span
                    class="status-indicator status-{{ 'pass' if model_performance else 'fail' }}"
                    >{{ 'Complete' if model_performance else 'Missing' }}</span
                  >
                </td>
                <td>
                  {{ "Performance metrics computed" if model_performance else
                  "No performance data" }}
                </td>
                <td>
                  {{ "Model performance assessed across standard metrics" if
                  model_performance else "Performance validation required" }}
                </td>
              </tr>
              <tr>
                <td><strong>Bias Testing</strong></td>
                <td>
                  <span
                    class="status-indicator status-{{ 'pass' if fairness_analysis else 'fail' }}"
                    >{{ 'Complete' if fairness_analysis else 'Missing' }}</span
                  >
                </td>
                <td>
                  {{ "Fairness analysis performed" if fairness_analysis else "No
                  bias testing" }}
                </td>
                <td>
                  {{ "Demographic fairness assessed" if fairness_analysis else
                  "Bias testing required for protected attributes" }}
                </td>
              </tr>
              <tr>
                <td><strong>Explainability</strong></td>
                <td>
                  <span
                    class="status-indicator status-{{ 'pass' if explanations else 'fail' }}"
                    >{{ 'Complete' if explanations else 'Missing' }}</span
                  >
                </td>
                <td>
                  {{ "SHAP explanations provided" if explanations else "No
                  explanations available" }}
                </td>
                <td>
                  {{ "Model decisions can be explained to stakeholders" if
                  explanations else "Explainability features required" }}
                </td>
              </tr>
              <tr>
                <td><strong>Reproducibility</strong></td>
                <td>
                  <span
                    class="status-indicator status-{{ 'pass' if (manifest and manifest.seeds) else 'fail' }}"
                    >{{ 'Complete' if (manifest and manifest.seeds) else
                    'Partial' }}</span
                  >
                </td>
                <td>
                  {{ "Full audit trail with seeds" if (manifest and
                  manifest.seeds) else "Limited reproducibility" }}
                </td>
                <td>
                  {{ "Results can be exactly reproduced" if (manifest and
                  manifest.seeds) else "Some randomness not controlled" }}
                </td>
              </tr>
              <tr>
                <td><strong>Data Governance</strong></td>
                <td>
                  <span
                    class="status-indicator status-{{ 'pass' if schema_info else 'warning' }}"
                    >{{ 'Complete' if schema_info else 'Partial' }}</span
                  >
                </td>
                <td>
                  {{ "Data schema documented" if schema_info else "Basic data
                  info only" }}
                </td>
                <td>
                  {{ "Data sources and processing documented" if schema_info
                  else "Enhanced data governance recommended" }}
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <h3>Regulatory Framework Assessment</h3>
        <div class="two-column">
          <div>
            <h4>GDPR Compliance (EU)</h4>
            <ul class="text-small">
              <li>[PASS] Right to explanation supported (SHAP analysis)</li>
              <li>
                [{{ 'PASS' if (manifest and manifest.seeds) else 'WARN' }}]
                Automated decision-making documented
              </li>
              <li>
                [{{ 'PASS' if fairness_analysis else 'FAIL' }}] Bias assessment
                performed
              </li>
              <li>
                [{{ 'PASS' if schema_info and schema_info.sensitive_features
                else 'WARN' }}] Sensitive data handling documented
              </li>
            </ul>
          </div>
          <div>
            <h4>Equal Credit Opportunity Act (US)</h4>
            <ul class="text-small">
              <li>
                [{{ 'PASS' if fairness_analysis else 'FAIL' }}] Disparate impact
                testing
              </li>
              <li>
                [{{ 'PASS' if explanations else 'FAIL' }}] Adverse action
                explanations available
              </li>
              <li>
                [{{ 'PASS' if (schema_info and schema_info.sensitive_features)
                else 'FAIL' }}] Protected class monitoring
              </li>
              <li>[PASS] Model performance documentation</li>
            </ul>
          </div>
        </div>

        {% set compliance_issues = [] %} {% if not fairness_analysis %}{% set _
        = compliance_issues.append("Bias testing required") %}{% endif %} {% if
        not explanations %}{% set _ = compliance_issues.append("Model
        explainability required") %}{% endif %} {% if not (manifest and
        manifest.seeds) %}{% set _ = compliance_issues.append("Full
        reproducibility required") %}{% endif %} {% if compliance_issues %}
        <div class="callout callout-danger">
          <h4>ALERT: Compliance Issues Detected</h4>
          <p>
            The following issues must be addressed before regulatory submission:
          </p>
          <ul>
            {% for issue in compliance_issues %}
            <li>{{ issue }}</li>
            {% endfor %}
          </ul>
        </div>
        {% else %}
        <div class="callout callout-success">
          <h4>Regulatory Compliance Status: PASS</h4>
          <p>This model audit meets standard regulatory requirements for:</p>
          <ul>
            <li>Explainable AI mandates</li>
            <li>Bias testing and fairness assessment</li>
            <li>Reproducibility and audit trail requirements</li>
            <li>Performance validation standards</li>
          </ul>
        </div>
        {% endif %}
      </section>

      <!-- Footer -->
      <footer class="footer">
        <hr />
        <div class="text-center text-small">
          <p>
            <strong
              >{{ report_title | default("ML Model Audit Report") }}</strong
            >
            | Generated by GlassAlpha v{{ version | default("1.0.0") }} | {{
            generation_date }}
          </p>
          <p class="text-muted">
            This report was generated using automated audit tools. Human review
            is recommended for regulatory submissions.
          </p>
        </div>
      </footer>
    </div>
  </body>
</html>
